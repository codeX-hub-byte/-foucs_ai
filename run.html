<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FOCUS AI: School Focus & Exam Detection</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- TensorFlow + MoveNet -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>

    <!-- Face Mesh for Eye Detection -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/face-landmarks-detection"></script>

    <style>
        body {
            background-color: #f6f7fb;
            color: #1e293b;
            font-family: "Segoe UI", sans-serif;
        }

        canvas {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border: 2px solid #d0d6e2;
            border-radius: 6px;
        }

        input[type=range] {
            accent-color: #2563eb;
        }

        .school-header {
            background-color: #1e3a8a;
            border-bottom: 3px solid #172554;
        }

        .hud-panel {
            background: #ffffff;
            border: 1px solid #d7dce3;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }

        .school-footer {
            background-color: #e2e8f0;
            color: #475569;
        }

        #loader, #examLoader {
            background: rgba(255,255,255,0.92);
        }

        #loader h2, #examLoader h2 { color: #1e3a8a; }
        #loader p, #examLoader p { color: #475569; }

        .focused-text { color: #059669 !important; }
        .warning-text { color: #ca8a04 !important; }
        .danger-text  { color: #dc2626 !important; }

        .suspect-text { color: #dc2626 !important; }
        .ok-text { color: #16a34a !important; }

        /* Splash */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000000;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            transition: opacity 0.5s ease-out;
        }

        #splash-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        #splash-screen img {
            width: 100%;
            max-width: 300px;
            height: auto;
        }

        .modeSelection-bg {
            background-color: #f6f7fb;
        }

        /* Dark Mode */
        body.dark-mode {
            background-color: #020617;
            color: #e5e7eb;
        }
        body.dark-mode .school-header {
            background-color: #020617;
            border-bottom-color: #0f172a;
        }
        body.dark-mode .school-footer {
            background-color: #020617;
            color: #9ca3af;
        }
        body.dark-mode .hud-panel {
            background-color: #020617;
            border-color: #1f2937;
        }
        body.dark-mode .modeSelection-bg {
            background-color: #020617;
        }
    </style>
</head>

<body class="h-screen flex flex-col overflow-hidden">

    <!-- Splash Screen -->
    <div id="splash-screen">
        <img src="ailogo.png" alt="FOCUS AI Logo">
    </div>

    <!-- MODE SELECTION SCREEN -->
    <div id="modeSelection" class="hidden flex-1 flex flex-col modeSelection-bg">
        <div class="school-header p-4 flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold text-white tracking-widest">FOCUS<span class="text-yellow-300">AI</span></h1>
                <p class="text-xs text-blue-200">School Monitoring & Analytics</p>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="toggleMainMenu()" class="p-2 rounded-full bg-blue-900/60 hover:bg-blue-800 text-blue-100">
                    ☰
                </button>
            </div>
        </div>

        <div class="flex-1 flex items-center justify-center px-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-3xl w-full">
                <button onclick="selectMode('class')" class="rounded-2xl bg-white shadow p-6 border hover:shadow-md transition">
                    <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-700 flex items-center justify-center font-bold">C</div>
                    <div class="text-sm font-bold text-slate-800 mt-2">Class Detection</div>
                </button>

                <button onclick="selectMode('exam')" class="rounded-2xl bg-white shadow p-6 border hover:shadow-md transition">
                    <div class="w-10 h-10 rounded-full bg-amber-100 text-amber-700 flex items-center justify-center font-bold">E</div>
                    <div class="text-sm font-bold text-slate-800 mt-2">Exam Detection</div>
                </button>
            </div>
        </div>

        <div class="school-footer p-3 text-[11px] text-center border-t border-slate-300">
            Choose a mode to begin monitoring
        </div>
    </div>

<!-- === PART 1 END — WAIT FOR PART 2 NEXT === -->
    <!-- CLASS DETECTION APP -->
    <div id="classApp" class="hidden flex-1 flex flex-col overflow-hidden">
        <div class="school-header p-4 flex flex-wrap justify-between items-center gap-4">
            <div>
                <h1 class="text-xl font-bold text-white tracking-widest">
                    FOCUS<span class="text-yellow-300">AI</span>
                </h1>
                <p class="text-xs text-blue-200">Class Activity Attention Tracking</p>
            </div>

            <div class="flex items-center gap-4 bg-white px-4 py-2 rounded-lg shadow hud-panel">
                <label class="text-xs font-bold text-slate-700">STRICTNESS:</label>
                <input id="sensitivity" type="range" min="10" max="90" value="50" class="w-32 h-1">
                <span id="senseVal" class="text-xs font-mono text-blue-700">50%</span>
            </div>

            <div class="flex gap-6 items-center">
                <div class="text-center">
                    <div class="text-[10px] text-blue-100 uppercase">Students</div>
                    <div id="countDisplay" class="text-2xl font-bold text-white leading-none">0</div>
                </div>
                <div class="text-center">
                    <div class="text-[10px] text-blue-100 uppercase">Focus Level</div>
                    <div id="focusDisplay" class="text-2xl font-bold text-white leading-none">--</div>
                </div>
                <div class="hidden sm:flex flex-col text-[10px] text-blue-100" id="activeStudentInfo">
                    <span id="activeStudentNameLabel">Student: --</span>
                    <span id="activeStudentRollLabel">Roll No: --</span>
                </div>
            </div>

            <div class="flex items-center gap-3">
                <div class="flex items-center gap-2">
                    <div id="recordStatus" class="w-3 h-3 bg-red-600 rounded-full hidden"></div>
                    <p id="recordText" class="text-sm font-bold text-white hidden">RECORDING...</p>
                </div>

                <button id="initBtn"
                    onclick="toggleSystem()"
                    class="bg-yellow-400 hover:bg-yellow-300 text-black px-4 py-2 rounded font-bold text-sm transition shadow">
                    START SYSTEM
                </button>

                <button onclick="toggleMainMenu()"
                    class="p-2 rounded-full bg-blue-900/60 hover:bg-blue-800 text-blue-100 flex flex-col justify-center">
                    <span class="block w-4 h-[2px] bg-blue-100 mb-[3px]"></span>
                    <span class="block w-4 h-[2px] bg-blue-100 mb-[3px]"></span>
                    <span class="block w-4 h-[2px] bg-blue-100"></span>
                </button>
            </div>
        </div>

        <div class="relative flex-1 bg-white w-full flex items-center justify-center overflow-hidden">
            <video id="video" class="hidden" playsinline></video>
            <canvas id="canvas"></canvas>

            <div id="loader" class="absolute inset-0 flex flex-col items-center justify-center z-30 hidden">
                <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                <h2 class="text-xl font-bold">LOADING AI MODEL</h2>
                <p class="text-sm mt-2">MoveNet Multi-Person Loading…</p>
            </div>
        </div>

        <div class="school-footer p-2 text-[10px] flex justify-center gap-6 border-t border-slate-300">
            <span class="flex items-center gap-1">
                <div class="w-2 h-2 bg-green-500 rounded-full"></div> Focused
            </span>
            <span class="flex items-center gap-1">
                <div class="w-2 h-2 bg-red-500 rounded-full"></div> Distracted / Suspect
            </span>
        </div>
    </div>

    <!-- EXAM DETECTION APP -->
    <div id="examApp" class="hidden flex-1 flex flex-col overflow-hidden">
        <div class="school-header p-4 flex flex-wrap justify-between items-center gap-4">
            <div>
                <h1 class="text-xl font-bold text-white tracking-widest">
                    FOCUS<span class="text-yellow-300">AI</span>
                </h1>
                <p class="text-xs text-blue-200">Exam Monitoring Mode</p>
            </div>

            <div class="flex items-center gap-6">
                <div class="flex flex-col text-[10px] text-blue-100" id="examActiveStudentInfo">
                    <span id="examActiveStudentNameLabel">Student: --</span>
                    <span id="examActiveStudentRollLabel">Roll No: --</span>
                </div>

                <div class="flex items-center gap-4 bg-white/95 px-4 py-2 rounded-lg shadow hud-panel">
                    <div class="text-[10px] font-bold text-slate-700 uppercase">Mode</div>
                    <div class="text-xs font-semibold text-amber-600">EXAM DETECTION · BETA</div>
                </div>

                <button onclick="toggleMainMenu()"
                    class="p-2 rounded-full bg-blue-900/60 hover:bg-blue-800 text-blue-100 flex flex-col justify-center">
                    <span class="block w-4 h-[2px] bg-blue-100 mb-[3px]"></span>
                    <span class="block w-4 h-[2px] bg-blue-100 mb-[3px]"></span>
                    <span class="block w-4 h-[2px] bg-blue-100"></span>
                </button>
            </div>
        </div>

        <div class="flex-1 flex flex-col items-center justify-center bg-white p-4 gap-4 w-full">
            <div class="hud-panel w-full max-w-3xl rounded-2xl overflow-hidden relative">
                <div class="border-b border-slate-200 px-4 py-2 flex justify-between items-center text-[11px] text-slate-500">
                    <span>Exam Camera · Live</span>
                    <span class="text-amber-600 font-semibold">
                        Watching eyes, head turn & looking down (no sound).
                    </span>
                </div>
                <div class="relative bg-black">
                    <video id="examVideo" class="hidden" playsinline></video>
                    <canvas id="examCanvas" class="w-full h-[360px]"></canvas>

                    <div id="examLoader" class="absolute inset-0 flex flex-col items-center justify-center z-30 hidden">
                        <div class="w-16 h-16 border-4 border-amber-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                        <h2 class="text-xl font-bold">LOADING EXAM AI</h2>
                        <p class="text-sm mt-2">Multi-student suspicion detection…</p>
                    </div>
                </div>
            </div>

            <div class="w-full max-w-3xl grid grid-cols-1 md:grid-cols-3 gap-3 text-[11px]">
                <div class="hud-panel rounded-xl px-3 py-2 flex flex-col">
                    <span class="uppercase text-slate-500 font-semibold mb-1">Total Examinees</span>
                    <span id="examTotalDisplay" class="text-lg font-bold text-slate-800">0</span>
                </div>
                <div class="hud-panel rounded-xl px-3 py-2 flex flex-col">
                    <span class="uppercase text-slate-500 font-semibold mb-1">Suspicious</span>
                    <span id="examSuspectDisplay" class="text-lg font-bold suspect-text">0</span>
                </div>
                <div class="hud-panel rounded-xl px-3 py-2 flex flex-col">
                    <span class="uppercase text-slate-500 font-semibold mb-1">Status</span>
                    <span id="examStatusText" class="text-xs font-semibold text-slate-700">
                        Exam AI running · silent visual alerts only.
                    </span>
                </div>
            </div>
        </div>

        <div class="school-footer p-2 text-[10px] flex justify-center gap-6 border-t border-slate-300">
            <span class="text-slate-600">
                FOCUSAI Exam Mode · Eyes + head + posture suspicion detection (no sound)
            </span>
        </div>
    </div>

    <!-- STUDENTS PAGE -->
    <div id="studentsView" class="hidden flex-1 flex flex-col overflow-hidden">
        <div class="school-header p-4 flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold text-white tracking-widest">
                    FOCUS<span class="text-yellow-300">AI</span>
                </h1>
                <p class="text-xs text-blue-200">Student Management</p>
            </div>
            <div class="flex items-center gap-3">
                <div class="text-xs text-blue-100 text-right hidden sm:block">
                    <div class="uppercase tracking-wide">Students</div>
                    <div class="text-[10px]">Add student details for display</div>
                </div>
                <button onclick="toggleMainMenu()"
                    class="p-2 rounded-full bg-blue-900/60 hover:bg-blue-800 text-blue-100 flex flex-col justify-center">
                    <span class="block w-4 h-[2px] bg-blue-100 mb-[3px]"></span>
                    <span class="block w-4 h-[2px] bg-blue-100 mb-[3px]"></span>
                    <span class="block w-4 h-[2px] bg-blue-100"></span>
                </button>
            </div>
        </div>

        <div class="flex-1 bg-slate-100 px-4 py-4 flex justify-center">
            <div class="max-w-4xl w-full flex flex-col gap-4">
                <div class="hud-panel rounded-2xl p-4 flex flex-col gap-2">
                    <div class="flex justify-between items-center">
                        <h2 class="text-sm font-bold text-slate-800">Add Student</h2>
                        <div class="text-[11px] text-slate-500">
                            Active Student:
                            <span id="studentsActiveDisplay" class="font-semibold text-blue-700">None selected</span>
                        </div>
                    </div>

                    <form id="studentForm" class="mt-2 grid grid-cols-1 md:grid-cols-4 gap-3" onsubmit="addStudent(event)">
                        <div class="flex flex-col gap-1">
                            <label class="text-[11px] font-semibold text-slate-600">Student Name</label>
                            <input id="studentName" type="text" required
                                class="border border-slate-300 rounded-md px-2 py-1 text-sm focus:outline-none focus:ring-1 focus:ring-blue-500">
                        </div>
                        <div class="flex flex-col gap-1">
                            <label class="text-[11px] font-semibold text-slate-600">Roll No</label>
                            <input id="studentRoll" type="text" required
                                class="border border-slate-300 rounded-md px-2 py-1 text-sm focus:outline-none focus:ring-1 focus:ring-blue-500">
                        </div>
                        <div class="flex flex-col gap-1">
                            <label class="text-[11px] font-semibold text-slate-600">Photo</label>
                            <input id="studentImage" type="file" accept="image/*" class="text-[11px]">
                        </div>
                        <div class="flex items-end">
                            <button type="submit"
                                class="w-full md:w-auto px-4 py-2 rounded-md bg-blue-600 text-white text-sm font-semibold hover:bg-blue-500">
                                Add Student
                            </button>
                        </div>
                    </form>
                </div>

                <div class="hud-panel rounded-2xl p-4">
                    <h2 class="text-sm font-bold text-slate-800 mb-2">Student List</h2>
                    <div id="studentsList" class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm"></div>
                    <div id="noStudentsMessage" class="text-[11px] text-slate-500 mt-2">
                        No students added yet. Add a student using the form above.
                    </div>
                </div>
            </div>
        </div>

        <div class="school-footer p-2 text-[10px] flex justify-center gap-6 border-t border-slate-300">
            <span class="text-slate-600">Student details are shown in Class & Exam headers</span>
        </div>
    </div>

    <!-- SETTINGS PAGE -->
    <div id="settingsView" class="hidden flex-1 flex flex-col overflow-hidden">
        <div class="school-header p-4 flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold text-white tracking-widest">
                    FOCUS<span class="text-yellow-300">AI</span>
                </h1>
                <p class="text-xs text-blue-200">Settings</p>
            </div>
            <div class="flex items-center gap-3">
                <div class="text-xs text-blue-100 text-right hidden sm:block">
                    <div class="uppercase tracking-wide">Display & Theme</div>
                    <div class="text-[10px]">Customize how FOCUSAI looks</div>
                </div>
                <button onclick="toggleMainMenu()"
                    class="p-2 rounded-full bg-blue-900/60 hover:bg-blue-800 text-blue-100 flex flex-col justify-center">
                    <span class="block w-4 h-[2px] bg-blue-100 mb-[3px]"></span>
                    <span class="block w-4 h-[2px] bg-blue-100 mb-[3px]"></span>
                    <span class="block w-4 h-[2px] bg-blue-100"></span>
                </button>
            </div>
        </div>

        <div class="flex-1 bg-slate-100 px-4 py-4 flex justify-center">
            <div class="max-w-3xl w-full flex flex-col gap-4">
                <div class="hud-panel rounded-2xl p-4 flex justify-between items-center">
                    <div>
                        <h2 class="text-sm font-bold text-slate-800">Theme</h2>
                        <p class="text-[11px] text-slate-500">Switch between light and dark mode.</p>
                    </div>
                    <select id="themeSelect"
                        class="border border-slate-300 rounded-md px-2 py-1 text-sm focus:outline-none focus:ring-1 focus:ring-blue-500">
                        <option value="light">Light Mode</option>
                        <option value="dark">Dark Mode</option>
                    </select>
                </div>

                <div class="hud-panel rounded-2xl p-4 flex justify-between items-center">
                    <div>
                        <h2 class="text-sm font-bold text-slate-800">Font Size</h2>
                        <p class="text-[11px] text-slate-500">Adjust the overall text size of the app.</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <input id="fontSizeRange" type="range" min="90" max="120" value="100">
                        <span id="fontSizeValue" class="text-xs text-slate-700">100%</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="school-footer p-2 text-[10px] flex justify-center gap-6 border-t border-slate-300">
            <span class="text-slate-600">Settings only change this browser's view</span>
        </div>
    </div>

    <!-- GLOBAL MENU -->
    <div id="mainMenu"
        class="hidden fixed right-4 top-14 z-50 bg-white rounded-xl shadow-lg border border-slate-200 text-sm">
        <button onclick="goHome()" class="block w-full text-left px-4 py-2 hover:bg-slate-100 border-b border-slate-100">
            Home
        </button>
        <button onclick="openStudents()" class="block w-full text-left px-4 py-2 hover:bg-slate-100 border-b border-slate-100">
            Students
        </button>
        <button onclick="openSettings()" class="block w-full text-left px-4 py-2 hover:bg-slate-100">
            Settings
        </button>
    </div>

    <!-- === SCRIPT / AI LOGIC START (CLASS + EXAM) WILL COME IN PART 3 === -->

<script>
// ------------ COMMON UI + SETTINGS + NAVIGATION -------------
const splashScreen = document.getElementById('splash-screen');
const modeSelection = document.getElementById('modeSelection');
const classApp = document.getElementById('classApp');
const examApp = document.getElementById('examApp');
const studentsView = document.getElementById('studentsView');
const settingsView = document.getElementById('settingsView');
const mainMenu = document.getElementById('mainMenu');

let currentTheme = 'light';

document.addEventListener("DOMContentLoaded", () => {
    setTimeout(() => {
        splashScreen.classList.add("hidden");
        modeSelection.classList.remove("hidden");
    }, 2000);

    const themeSelect = document.getElementById("themeSelect");
    const fontSizeRange = document.getElementById("fontSizeRange");

    if (themeSelect) {
        themeSelect.addEventListener("change", () => {
            applyTheme(themeSelect.value);
        });
    }

    if (fontSizeRange) {
        fontSizeRange.addEventListener("input", (e) => applyFontSize(e.target.value));
        applyFontSize(fontSizeRange.value);
    }

    updateActiveStudentUI();
});

function toggleMainMenu() {
    mainMenu.classList.toggle("hidden");
}
function closeMainMenu() {
    mainMenu.classList.add("hidden");
}

function hideAllViews() {
    modeSelection.classList.add("hidden");
    classApp.classList.add("hidden");
    examApp.classList.add("hidden");
    studentsView.classList.add("hidden");
    settingsView.classList.add("hidden");
}

function goHome() {
    stopSystem();
    stopExamSystem();
    hideAllViews();
    modeSelection.classList.remove("hidden");
    closeMainMenu();
}

function openStudents() {
    stopSystem();
    stopExamSystem();
    hideAllViews();
    studentsView.classList.remove("hidden");
    closeMainMenu();
}

function openSettings() {
    hideAllViews();
    settingsView.classList.remove("hidden");
    closeMainMenu();
}

function selectMode(mode) {
    hideAllViews();
    if (mode === "class") classApp.classList.remove("hidden");
    if (mode === "exam") {
        examApp.classList.remove("hidden");
        initExamSystem();
    }
    closeMainMenu();
}

function applyTheme(theme) {
    currentTheme = theme;
    if (theme === "dark") document.body.classList.add("dark-mode");
    else document.body.classList.remove("dark-mode");
}

function applyFontSize(percent) {
    document.documentElement.style.fontSize = percent + "%";
    document.getElementById("fontSizeValue").innerText = percent + "%";
}

// STUDENT DATA SYSTEM
let students = [];
let activeStudent = null;

function addStudent(e) {
    e.preventDefault();
    const name = studentName.value.trim();
    const roll = studentRoll.value.trim();
    const file = studentImage.files[0];
    if (!name || !roll) {
        alert("Enter Name & Roll No");
        return;
    }
    const onComplete = (imageData) => {
        students.push({
            id: Date.now(),
            name,
            roll,
            image: imageData || null
        });
        renderStudentsList();
        studentForm.reset();
    };
    if (file) {
        const reader = new FileReader();
        reader.onload = () => onComplete(reader.result);
        reader.readAsDataURL(file);
    } else onComplete(null);
}

function setActiveStudent(i) {
    activeStudent = students[i];
    updateActiveStudentUI();
}

function updateActiveStudentUI() {
    const name = activeStudent?.name || "--";
    const roll = activeStudent?.roll || "--";
    if (activeStudentNameLabel) activeStudentNameLabel.innerText = "Student: " + name;
    if (activeStudentRollLabel) activeStudentRollLabel.innerText = "Roll No: " + roll;
    if (examActiveStudentNameLabel) examActiveStudentNameLabel.innerText = "Student: " + name;
    if (examActiveStudentRollLabel) examActiveStudentRollLabel.innerText = "Roll No: " + roll;
    if (studentsActiveDisplay) studentsActiveDisplay.innerText = activeStudent ? name + " (Roll " + roll + ")" : "None selected";
}

function renderStudentsList() {
    studentsList.innerHTML = "";
    if (students.length === 0) {
        noStudentsMessage.style.display = "block";
        return;
    }
    noStudentsMessage.style.display = "none";
    students.forEach((s, i) => {
        const div = document.createElement("div");
        div.className = "border rounded-xl bg-white p-2 flex gap-2 items-center";
        div.innerHTML = `
            <div class="w-12 h-12 rounded-full overflow-hidden bg-slate-200">
                ${s.image ? `<img src="${s.image}" class="w-full h-full object-cover">` : "No Img"}
            </div>
            <div class="flex-1">
                <div class="font-semibold">${s.name}</div>
                <div class="text-xs text-slate-500">Roll: ${s.roll}</div>
            </div>
            <button class="bg-blue-600 text-white text-xs px-3 py-1 rounded" onclick="setActiveStudent(${i})">
                Set Active
            </button>`;
        studentsList.appendChild(div);
    });
}
</script>
<script>
// ------------ CLASS MODE: AI + RECORDING ------------

// Globals
let poseDetector = null;
let isRunning = false;
let isRecording = false;
let mediaRecorder = null;
let recordedChunks = [];
let stream = null;

// DOM refs
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

const loader = document.getElementById('loader');
const initBtn = document.getElementById('initBtn');
const recordStatus = document.getElementById('recordStatus');
const recordText = document.getElementById('recordText');

const countDisplay = document.getElementById('countDisplay');
const focusDisplay = document.getElementById('focusDisplay');
const senseSlider = document.getElementById('sensitivity');
const senseVal = document.getElementById('senseVal');

// Strictness affects how centered the nose must be between shoulders
let STRICTNESS_THRESHOLD = 0.5;
senseSlider.oninput = (e) => {
    STRICTNESS_THRESHOLD = e.target.value / 100;
    senseVal.innerText = e.target.value + "%";
};

// ---- Helper functions for pose analysis ----
function getKey(pose, name) {
    return pose.keypoints.find(k => k.name === name);
}

// Eye direction using nose & eyes geometry
function getEyeDirection(nose, leftEye, rightEye) {
    if (!nose || !leftEye || !rightEye) return "UNKNOWN";
    if (nose.score < 0.2 || leftEye.score < 0.2 || rightEye.score < 0.2) return "UNKNOWN";

    const dL = Math.hypot(nose.x - leftEye.x, nose.y - leftEye.y);
    const dR = Math.hypot(nose.x - rightEye.x, nose.y - rightEye.y);
    if (dR === 0) return "UNKNOWN";
    const ratio = dL / dR;

    if (ratio > 1.25) return "RIGHT";   // watching to their right
    if (ratio < 0.80) return "LEFT";    // watching to their left
    return "CENTER";
}

// Head vertical status: UP, NORMAL, DOWN, DOWN/PHONE
function getHeadStatus(nose, ls, rs) {
    if (!nose || !ls || !rs) return "UNKNOWN";
    if (nose.score < 0.2 || ls.score < 0.2 || rs.score < 0.2) return "UNKNOWN";

    const shouldersY = (ls.y + rs.y) / 2;
    const shouldersWidth = Math.abs(ls.x - rs.x) || 1;
    const offsetY = nose.y - shouldersY;  // >0 means below shoulders

    const ratio = offsetY / shouldersWidth;

    if (ratio < -0.2) return "UP";
    if (ratio < 0.35) return "NORMAL";
    if (ratio < 0.55) return "DOWN";
    return "DOWN/PHONE";
}

// Horizontal head turn (how much nose is shifted sideways relative to shoulders)
function getHeadTurnRatio(nose, ls, rs) {
    if (!nose || !ls || !rs) return 0;
    const centerX = (ls.x + rs.x) / 2;
    const width = Math.abs(ls.x - rs.x) || 1;
    return Math.abs(nose.x - centerX) / width;
}

// ---- CLASS MODE CONTROL ----
async function toggleSystem() {
    if (!isRunning) {
        await initSystem();
    } else {
        stopSystem();
    }
}

async function initSystem() {
    if (isRunning) return;
    loader.classList.remove("hidden");
    initBtn.disabled = true;

    try {
        stream = await navigator.mediaDevices.getUserMedia({
            video: { width: 1280, height: 720, facingMode: 'user' }
        });

        video.srcObject = stream;
        await new Promise(res => video.onloadedmetadata = res);
        await video.play();

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        // Create MoveNet Multi-pose detector
        poseDetector = await poseDetection.createDetector(
            poseDetection.SupportedModels.MoveNet,
            {
                modelType: poseDetection.movenet.modelType.MULTIPOSE_LIGHTNING,
                enableSmoothing: true,
                minPoseScore: 0.25
            }
        );

        loader.classList.add("hidden");
        isRunning = true;
        initBtn.disabled = false;
        initBtn.innerText = "STOP SYSTEM";
        initBtn.classList.remove("bg-yellow-400", "hover:bg-yellow-300", "text-black");
        initBtn.classList.add("bg-red-600", "hover:bg-red-500", "text-white");

        startRecording();
        renderLoop();

    } catch (err) {
        alert("Error starting webcam or AI: " + err.message);
        loader.classList.add("hidden");
        initBtn.disabled = false;
    }
}

function stopSystem() {
    isRunning = false;

    if (isRecording && mediaRecorder && mediaRecorder.state !== "inactive") {
        mediaRecorder.stop();
    }

    if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
    }

    initBtn.innerText = "START SYSTEM";
    initBtn.classList.remove("bg-red-600", "hover:bg-red-500", "text-white");
    initBtn.classList.add("bg-yellow-400", "hover:bg-yellow-300", "text-black");

    recordStatus.classList.add("hidden");
    recordStatus.classList.remove("recording-status");
    recordText.classList.add("hidden");
}

async function renderLoop() {
    if (!isRunning || !poseDetector) return;

    const poses = await poseDetector.estimatePoses(video, {
        maxPoses: 20,
        flipHorizontal: false
    });

    drawResults(poses);
    requestAnimationFrame(renderLoop);
}

// ---- DRAW RESULTS: CLASS MODE ----
function drawResults(poses) {
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    ctx.fillStyle = "rgba(255,255,255,0.40)";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    let total = 0;
    let focusedCount = 0;

    poses.forEach(pose => {
        if (pose.score < 0.25) return;
        total++;

        const nose = getKey(pose, "nose");
        const ls   = getKey(pose, "left_shoulder");
        const rs   = getKey(pose, "right_shoulder");
        const le   = getKey(pose, "left_eye");
        const re   = getKey(pose, "right_eye");

        if (!ls || !rs || ls.score < 0.3 || rs.score < 0.3) return;

        // Base focus from horizontal alignment
        const headTurn = getHeadTurnRatio(nose, ls, rs);
        let focused = headTurn < (1 - STRICTNESS_THRESHOLD);

        const eyeDir = getEyeDirection(nose, le, re); // CENTER / LEFT / RIGHT / UNKNOWN
        const headStatus = getHeadStatus(nose, ls, rs); // UP / NORMAL / DOWN / DOWN/PHONE / UNKNOWN

        // More strict: must be CENTER & not looking DOWN/PHONE
        if (eyeDir !== "CENTER") focused = false;
        if (headStatus === "DOWN" || headStatus === "DOWN/PHONE") focused = false;

        if (focused) focusedCount++;

        // Color logic
        let color = "#059669";  // green
        if (!focused) color = "#dc2626";

        // Draw circle around head
        if (nose) {
            const r = Math.max(30, Math.abs(ls.x - rs.x) * 0.6);
            ctx.strokeStyle = color;
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.arc(nose.x, nose.y, r, 0, 2 * Math.PI);
            ctx.stroke();

            ctx.fillStyle = color;
            ctx.font = "bold 13px Segoe UI";

            // First line: status
            const statusText = focused ? "FOCUSED" :
                (headStatus === "DOWN/PHONE" ? "DOWN / PHONE?" :
                 (headStatus === "DOWN" ? "LOOKING DOWN" : "DISTRACTED"));

            ctx.fillText(statusText, nose.x - r, nose.y - r - 8);

            // Second line: eyes
            ctx.font = "11px Segoe UI";
            ctx.fillText("Eyes: " + eyeDir, nose.x - r, nose.y - r - 22);
        }

        // Shoulder line
        ctx.strokeStyle = color;
        ctx.lineWidth = 4;
        ctx.beginPath();
        ctx.moveTo(ls.x, ls.y);
        ctx.lineTo(rs.x, rs.y);
        ctx.stroke();
    });

    countDisplay.innerText = total;
    const pct = total > 0 ? Math.round((focusedCount / total) * 100) : 0;
    focusDisplay.innerText = pct + "%";

    if (pct > 80) focusDisplay.className = "text-2xl font-bold focused-text";
    else if (pct > 50) focusDisplay.className = "text-2xl font-bold warning-text";
    else focusDisplay.className = "text-2xl font-bold danger-text";
}

// ---- Recording (download only) ----
function startRecording() {
    if (!stream) {
        console.warn("No stream to record.");
        return;
    }

    try {
        recordedChunks = [];
        mediaRecorder = new MediaRecorder(stream, {
            mimeType: "video/webm;codecs=vp9"
        });

        mediaRecorder.ondataavailable = (event) => {
            if (event.data && event.data.size > 0) {
                recordedChunks.push(event.data);
            }
        };

        mediaRecorder.onstop = () => {
            isRecording = false;
            if (recordedChunks.length > 0) {
                const blob = new Blob(recordedChunks, { type: "video/webm" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                const timestamp = new Date().toISOString().replace(/[:.]/g, "-");
                a.href = url;
                a.download = `focusai-class-${timestamp}.webm`;
                document.body.appendChild(a);
                a.click();
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
            }
        };

        mediaRecorder.start();
        isRecording = true;

        recordStatus.classList.remove("hidden");
        recordStatus.classList.add("recording-status");
        recordText.classList.remove("hidden");

    } catch (err) {
        alert("Error starting recording: " + err.message);
    }
}

window.addEventListener("beforeunload", () => {
    if (isRecording && mediaRecorder && mediaRecorder.state !== "inactive") {
        mediaRecorder.stop();
    }
});

// ------------ EXAM MODE (CLASSROOM) -------------
let examStream = null;
let examIsRunning = false;
let examDetector = null;

const examVideo = document.getElementById('examVideo');
const examCanvas = document.getElementById('examCanvas');
const examCtx = examCanvas.getContext('2d');
const examLoader = document.getElementById('examLoader');

const examTotalDisplay = document.getElementById('examTotalDisplay');
const examSuspectDisplay = document.getElementById('examSuspectDisplay');
const examStatusText = document.getElementById('examStatusText');

async function initExamSystem() {
    if (examIsRunning) return;
    examLoader.classList.remove("hidden");

    try {
        examStream = await navigator.mediaDevices.getUserMedia({
            video: {
                width: 1920,
                height: 1080,
                facingMode: 'environment'
            }
        });

        examVideo.srcObject = examStream;
        await new Promise(res => examVideo.onloadedmetadata = res);
        await examVideo.play();

        examCanvas.width = examVideo.videoWidth;
        examCanvas.height = examVideo.videoHeight;

        examDetector = await poseDetection.createDetector(
            poseDetection.SupportedModels.MoveNet,
            {
                modelType: poseDetection.movenet.modelType.MULTIPOSE_LIGHTNING,
                enableSmoothing: true,
                minPoseScore: 0.15
            }
        );

        examLoader.classList.add("hidden");
        examIsRunning = true;
        examStatusText.innerText = "Exam AI running · Watching eyes, head turn & looking down (silent).";

        examRenderLoop();

    } catch (err) {
        alert("Error starting exam camera or AI: " + err.message);
        examLoader.classList.add("hidden");
    }
}

function stopExamSystem() {
    examIsRunning = false;
    if (examStream) {
        examStream.getTracks().forEach(t => t.stop());
        examStream = null;
    }
}

// Exam loop
async function examRenderLoop() {
    if (!examIsRunning || !examDetector) return;

    const poses = await examDetector.estimatePoses(examVideo, {
        maxPoses: 30,
        flipHorizontal: false
    });

    drawExamResults(poses);
    requestAnimationFrame(examRenderLoop);
}

// Draw exam overlays
function drawExamResults(poses) {
    examCtx.drawImage(examVideo, 0, 0, examCanvas.width, examCanvas.height);
    examCtx.fillStyle = "rgba(0,0,0,0.3)";
    examCtx.fillRect(0, 0, examCanvas.width, examCanvas.height);

    let total = 0;
    let suspects = 0;

    poses.forEach(pose => {
        if (pose.score < 0.20) return;
        total++;

        const nose = getKey(pose, "nose");
        const ls   = getKey(pose, "left_shoulder");
        const rs   = getKey(pose, "right_shoulder");
        const le   = getKey(pose, "left_eye");
        const re   = getKey(pose, "right_eye");

        if (!nose || !ls || !rs) return;
        if (nose.score < 0.25 || ls.score < 0.25 || rs.score < 0.25) return;

        const headTurnRatio = getHeadTurnRatio(nose, ls, rs);
        const headStatus = getHeadStatus(nose, ls, rs);
        const eyeDir = getEyeDirection(nose, le, re);

        // Build suspicion score
        let suspicionScore = 0;

        // Strong side look
        if (headTurnRatio > 0.35) suspicionScore += 1;
        if (headTurnRatio > 0.55) suspicionScore += 1;

        // Looking down / phone
        if (headStatus === "DOWN" || headStatus === "DOWN/PHONE") suspicionScore += 1;
        if (headStatus === "DOWN/PHONE") suspicionScore += 1; // stronger suspicion

        // Eye not center
        if (eyeDir === "LEFT" || eyeDir === "RIGHT") suspicionScore += 1;

        const suspicious = suspicionScore >= 2;
        if (suspicious) suspects++;

        const shouldersWidth = Math.abs(ls.x - rs.x) || 40;
        const color = suspicious ? "#dc2626" : "#16a34a";
        const label = suspicious ? "SUSPECT" : "OK";

        // Draw head circle
        examCtx.strokeStyle = color;
        examCtx.lineWidth = 2;
        examCtx.beginPath();
        examCtx.arc(nose.x, nose.y, shouldersWidth * 0.8, 0, 2 * Math.PI);
        examCtx.stroke();

        // Label
        examCtx.fillStyle = color;
        examCtx.font = "bold 12px Segoe UI";
        examCtx.fillText(label, nose.x - shouldersWidth * 0.7, nose.y - shouldersWidth * 0.9);

        examCtx.font = "10px Segoe UI";
        examCtx.fillText("Eyes: " + eyeDir, nose.x - shouldersWidth * 0.7, nose.y - shouldersWidth * 0.9 - 14);
        examCtx.fillText("Head: " + headStatus, nose.x - shouldersWidth * 0.7, nose.y - shouldersWidth * 0.9 - 28);

        // Shoulder line
        examCtx.strokeStyle = color;
        examCtx.lineWidth = 3;
        examCtx.beginPath();
        examCtx.moveTo(ls.x, ls.y);
        examCtx.lineTo(rs.x, rs.y);
        examCtx.stroke();
    });

    examTotalDisplay.innerText = total;
    examSuspectDisplay.innerText = suspects;
}
</script>
</body>
</html>
